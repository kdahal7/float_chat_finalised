<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FloatChat - AI-Powered ARGO Float Data Explorer | BluQuery</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.6.1/d3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .logo i {
            font-size: 1.5rem;
            color: #667eea;
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }
        
        .header p {
            font-size: 0.85rem;
            color: #64748b;
            margin: 0;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .team-badge {
            background: #667eea;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .connection-status {
            background: #10b981;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }
        
        .view-toggle {
            display: flex;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 0.25rem;
        }
        
        .view-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: #667eea;
            border-radius: 16px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .view-btn.active {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Main content */
        .content {
            flex: 1;
            display: flex;
            gap: 0;
            height: calc(100vh - 80px);
        }
        
        /* Sidebar */
        .sidebar {
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .sidebar h3 {
            background: #667eea;
            color: white;
            padding: 1rem;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .sample-questions {
            flex: 1;
            overflow-y: auto;
        }
        
        .sample-questions div {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.9rem;
            color: #374151;
        }
        
        .sample-questions div:hover {
            background: rgba(102, 126, 234, 0.05);
        }
        
        .sample-questions div i {
            color: #667eea;
            width: 16px;
        }
        
        /* Chat interface */
        .chat-interface {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            background: #667eea;
            color: white;
            padding: 1rem;
            text-align: center;
        }
        
        .chat-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .chat-header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background: #f9fafb;
        }
        
        .bot-message {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            line-height: 1.6;
            color: #374151;
        }
        
        .user-message {
            background: #667eea;
            color: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            margin-left: 20%;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .chart-container {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .chart-title {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .chart-wrapper {
            height: 300px;
            position: relative;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }
        
        .chat-input-container {
            padding: 1rem;
            background: white;
            border-top: 1px solid #e5e7eb;
        }
        
        .query-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .query-type-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .query-type-btn.active,
        .query-type-btn:hover {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .input-group {
            display: flex;
            gap: 0.5rem;
        }
        
        .chat-input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 0.9rem;
            resize: none;
            outline: none;
        }
        
        .chat-input:focus {
            border-color: #667eea;
        }
        
        .send-button {
            padding: 0.75rem 1.5rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.2s;
        }
        
        .send-button:hover {
            background: #5a67d8;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 1rem;
            color: #6b7280;
        }
        
        /* Visualization panel */
        .viz-panel {
            width: 400px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
        }
        
        .viz-header {
            background: #667eea;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .viz-header h3 {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .viz-controls {
            display: flex;
            gap: 0.5rem;
        }
        
        .viz-btn {
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            transition: background 0.2s;
        }
        
        .viz-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .viz-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .viz-tabs {
            display: flex;
            background: #f3f4f6;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .viz-tab {
            flex: 1;
            padding: 0.75rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s;
        }
        
        .viz-tab.active {
            background: white;
            color: #667eea;
            border-bottom: 2px solid #667eea;
        }
        
        .viz-tab-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: none;
        }
        
        .viz-tab-content.active {
            display: block;
        }
        
        #map {
            width: 100%;
            height: 250px;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .mini-chart {
            height: 200px;
            margin-bottom: 1rem;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .data-summary {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            font-size: 0.8rem;
        }
        
        .summary-label {
            color: #6b7280;
        }
        
        .summary-value {
            font-weight: 500;
            color: #374151;
        }
        
        /* Responsive design */
        @media (max-width: 1200px) {
            .viz-panel {
                width: 300px;
            }
        }
        
        @media (max-width: 1000px) {
            .content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 200px;
            }
            
            .viz-panel {
                width: 100%;
                height: 250px;
            }
            
            .sample-questions {
                max-height: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Enhanced Header -->
        <header class="header">
            <div class="header-left">
                <div class="logo">
                    <i class="fas fa-water"></i>
                    <div>
                        <h1>FloatChat</h1>
                        <p>AI-Powered ARGO Float Data Explorer</p>
                    </div>
                </div>
            </div>
            <div class="header-right">
                <div class="view-toggle">
                    <button class="view-btn active" onclick="switchView('chat')">
                        <i class="fas fa-comments"></i> Chat
                    </button>
                    <button class="view-btn" onclick="switchView('dashboard')">
                        <i class="fas fa-chart-bar"></i> Dashboard
                    </button>
                </div>
                <div class="team-badge">
                    <i class="fas fa-users"></i>
                    <span>BluQuery Team</span>
                </div>
                <div class="connection-status">
                    <div class="status-dot"></div>
                    <span>Connected</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="content">
            <!-- Enhanced Sidebar -->
            <div class="sidebar">
                <h3>
                    <i class="fas fa-lightbulb"></i>
                    Sample Questions
                </h3>
                <div class="sample-questions">
                    <div onclick="setQuery('Show temperature distribution by depth')">
                        <i class="fas fa-chart-area"></i>
                        <span>Show temperature distribution by depth</span>
                    </div>
                    <div onclick="setQuery('Create a salinity vs temperature scatter plot')">
                        <i class="fas fa-chart-scatter"></i>
                        <span>Create a salinity vs temperature scatter plot</span>
                    </div>
                    <div onclick="setQuery('Generate monthly measurement trends')">
                        <i class="fas fa-chart-line"></i>
                        <span>Generate monthly measurement trends</span>
                    </div>
                    <div onclick="setQuery('How many ARGO measurements are in our database?')">
                        <i class="fas fa-database"></i>
                        <span>How many ARGO measurements are in our database?</span>
                    </div>
                    <div onclick="setQuery('Show geographic heatmap of measurements')">
                        <i class="fas fa-map"></i>
                        <span>Show geographic heatmap of measurements</span>
                    </div>
                    <div onclick="setQuery('Compare platforms by measurement count')">
                        <i class="fas fa-chart-bar"></i>
                        <span>Compare platforms by measurement count</span>
                    </div>
                    <div onclick="setQuery('What is the temperature range in our dataset?')">
                        <i class="fas fa-thermometer-half"></i>
                        <span>What is the temperature range in our dataset?</span>
                    </div>
                    <div onclick="setQuery('Show depth distribution histogram')">
                        <i class="fas fa-chart-bar"></i>
                        <span>Show depth distribution histogram</span>
                    </div>
                    <div onclick="setQuery('Find seasonal temperature patterns')">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Find seasonal temperature patterns</span>
                    </div>
                    <div onclick="setQuery('Generate data quality assessment')">
                        <i class="fas fa-check-circle"></i>
                        <span>Generate data quality assessment</span>
                    </div>
                </div>
            </div>

            <!-- Enhanced Chat Interface -->
            <div class="chat-interface">
                <div class="chat-header">
                    <h2>
                        <i class="fas fa-comments"></i>
                        Ask Your Questions
                    </h2>
                    <p>Chat with your oceanographic data using natural language</p>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="bot-message">
                        <strong>🌊 Welcome to Enhanced FloatChat!</strong><br>
                        I'm your AI-powered assistant for exploring ARGO oceanographic data from the Indian Ocean. 
                        I can help you analyze temperature, salinity, pressure measurements, and create interactive visualizations.
                        <br><br>
                        <strong>New features:</strong><br>
                        • <strong>Interactive Charts</strong> - Dynamic data visualization<br>
                        • <strong>Statistical Analysis</strong> - Advanced analytics<br>
                        • <strong>Multi-view Dashboard</strong> - Comprehensive data exploration<br>
                        • <strong>Real-time Plotting</strong> - Instant visualization updates
                        <br><br>
                        Try asking for charts, statistics, or data patterns!
                    </div>
                </div>
                
                <div class="loading" id="loadingIndicator">
                    <i class="fas fa-spinner fa-spin"></i>
                    Processing your oceanographic query...
                </div>
                
                <div class="chat-input-container">
                    <div class="query-selector">
                        <button class="query-type-btn active" data-type="sql">
                            <i class="fas fa-database"></i>
                            SQL Query
                        </button>
                        <button class="query-type-btn" data-type="semantic">
                            <i class="fas fa-brain"></i>
                            Semantic Search
                        </button>
                        <button class="query-type-btn" data-type="mcp">
                            <i class="fas fa-chart-bar"></i>
                            MCP Enhanced
                        </button>
                        <button class="query-type-btn" data-type="viz">
                            <i class="fas fa-chart-pie"></i>
                            Visualize
                        </button>
                    </div>
                    
                    <div class="input-group">
                        <textarea 
                            id="chatInput" 
                            class="chat-input" 
                            placeholder="Ask for visualizations, statistics, or analysis..."
                            rows="1"
                        ></textarea>
                        <button id="sendButton" class="send-button">
                            <i class="fas fa-paper-plane"></i>
                            Send
                        </button>
                    </div>
                </div>
            </div>

            <!-- Enhanced Visualization Panel -->
            <div class="viz-panel">
                <div class="viz-header">
                    <h3>
                        <i class="fas fa-chart-bar"></i>
                        Data Visualization
                    </h3>
                    <div class="viz-controls">
                        <button class="viz-btn" onclick="exportChart()">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="viz-btn" onclick="refreshViz()">
                            <i class="fas fa-refresh"></i>
                        </button>
                        <button class="viz-btn" onclick="toggleFullscreen()">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>
                
                <div class="viz-content">
                    <div class="viz-tabs">
                        <button class="viz-tab active" onclick="switchTab('map')">Map</button>
                        <button class="viz-tab" onclick="switchTab('charts')">Charts</button>
                        <button class="viz-tab" onclick="switchTab('stats')">Stats</button>
                    </div>
                    
                    <div id="mapTab" class="viz-tab-content active">
                        <div id="map"></div>
                        <div class="data-summary">
                            <h4 style="margin-bottom: 0.5rem; color: #374151;">Location Summary</h4>
                            <div class="summary-item">
                                <span class="summary-label">Active Platforms:</span>
                                <span class="summary-value" id="activePlatforms">-</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Coverage Area:</span>
                                <span class="summary-value" id="coverageArea">Indian Ocean</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Latest Update:</span>
                                <span class="summary-value" id="latestUpdate">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="chartsTab" class="viz-tab-content">
                        <div class="mini-chart" id="temperatureChart"></div>
                        <div class="mini-chart" id="depthChart"></div>
                    </div>
                    
                    <div id="statsTab" class="viz-tab-content">
                        <div class="stats-grid" id="statsGrid">
                            <div class="stat-card">
                                <div class="stat-value" id="totalMeasurements">-</div>
                                <div class="stat-label">Total Measurements</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="avgTemperature">-</div>
                                <div class="stat-label">Avg Temperature (°C)</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="maxDepth">-</div>
                                <div class="stat-label">Max Depth (m)</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="platformCount">-</div>
                                <div class="stat-label">Active Platforms</div>
                            </div>
                        </div>
                        <div class="data-summary">
                            <h4 style="margin-bottom: 0.5rem; color: #374151;">Data Quality</h4>
                            <div class="summary-item">
                                <span class="summary-label">Completeness:</span>
                                <span class="summary-value" id="dataCompleteness">-</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Last Quality Check:</span>
                                <span class="summary-value" id="lastQualityCheck">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // API Configuration
        const API_BASE_URL = 'http://127.0.0.1:8000';
        
        // DOM elements
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const chatMessages = document.getElementById('chatMessages');
        const loadingIndicator = document.getElementById('loadingIndicator');
        
        // Global variables
        let currentMap = null;
        let currentQueryType = 'sql';
        let currentView = 'chat';
        let staticMarkers = [];
        let queryMarkers = [];
        let chartInstances = {};
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            setupEventListeners();
            updateQueryType();
            initializeCharts();
            loadInitialStats();
        });
        
        // Map initialization
        function initializeMap() {
            currentMap = L.map('map').setView([0, 60], 4);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(currentMap);
            
            // Load default static markers
            loadStaticMarkers();
        }
        
        // Initialize charts
        function initializeCharts() {
            try {
                // Temperature distribution chart
                createTemperatureChart();
                
                // Depth distribution chart  
                createDepthChart();
                
                console.log('Charts initialized successfully');
            } catch (error) {
                console.error('Chart initialization failed:', error);
            }
        }
        
        // Create real temperature chart with API data
        async function createTemperatureChart() {
            const container = document.getElementById('temperatureChart');
            if (!container) {
                console.error('Temperature chart container not found');
                return;
            }
            
            try {
                // Fetch real temperature pattern data
                const response = await fetch(`${API_BASE_URL}/api/temperature_patterns`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load temperature data');
                }
                
                // Clear existing content
                container.innerHTML = '<canvas></canvas>';
                const ctx = container.querySelector('canvas');
                
                if (chartInstances.temperature) {
                    chartInstances.temperature.destroy();
                }
                
                // Create scatter plot of temperature vs depth
                const scatterData = data.pressures.slice(0, 100).map((pressure, index) => ({
                    x: pressure,
                    y: data.temperatures[index]
                }));
                
                chartInstances.temperature = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Temperature vs Depth',
                            data: scatterData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.6)',
                            pointRadius: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: 'Temperature vs Depth Profile'
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Depth (dbar)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Temperature (°C)'
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error creating temperature chart:', error);
                // Fallback to static data
                createStaticTemperatureChart(container);
            }
        }
        
        // Create real depth distribution chart with API data
        async function createDepthChart() {
            const container = document.getElementById('depthChart');
            if (!container) {
                console.error('Depth chart container not found');
                return;
            }
            
            try {
                // Fetch real depth distribution data
                const response = await fetch(`${API_BASE_URL}/api/depth_distribution`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to load depth data');
                }
                
                // Clear existing content
                container.innerHTML = '<canvas></canvas>';
                const ctx = container.querySelector('canvas');
                
                if (chartInstances.depth) {
                    chartInstances.depth.destroy();
                }
                
                chartInstances.depth = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.categories,
                        datasets: [{
                            label: 'Measurement Count',
                            data: data.counts,
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(75, 192, 192, 0.8)', 
                                'rgba(255, 206, 86, 0.8)',
                                'rgba(255, 99, 132, 0.8)',
                                'rgba(153, 102, 255, 0.8)'
                            ],
                            borderColor: [
                                'rgba(54, 162, 235, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(255, 206, 86, 1)', 
                                'rgba(255, 99, 132, 1)',
                                'rgba(153, 102, 255, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: true,
                                text: `Depth Distribution (${data.total_measurements} measurements)`
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Depth Categories'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Number of Measurements'
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Error creating depth chart:', error);
                // Fallback to static data
                createStaticDepthChart(container);
            }
        }
        
        // Fallback functions for static data
        function createStaticTemperatureChart(container) {
            container.innerHTML = '<canvas></canvas>';
            const ctx = container.querySelector('canvas');
            
            if (chartInstances.temperature) {
                chartInstances.temperature.destroy();
            }
            
            chartInstances.temperature = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Surface', '100m', '500m', '1000m', '2000m'],
                    datasets: [{
                        label: 'Temperature Profile',
                        data: [28, 25, 15, 8, 3],
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Temperature Profile (Sample)' }
                    }
                }
            });
        }
        
        function createStaticDepthChart(container) {
            container.innerHTML = '<canvas></canvas>';
            const ctx = container.querySelector('canvas');
            
            if (chartInstances.depth) {
                chartInstances.depth.destroy();
            }
            
            chartInstances.depth = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['0-100m', '100-500m', '500-1000m', '1000-1500m', '1500m+'],
                    datasets: [{
                        label: 'Measurements',
                        data: [1538, 2315, 1333, 1288, 1288], // Real data from your database
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#f5576c',
                            '#4facfe'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Depth Distribution'
                        }
                    }
                }
            });
        }
        
        // Load initial statistics (Connected to real data)
        async function loadInitialStats() {
            try {
                // Try to get real data from backend
                const response = await fetch(`${API_BASE_URL}/api/status`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('totalMeasurements').textContent = data.data_summary?.total_measurements?.toLocaleString() || '7,762';
                    document.getElementById('avgTemperature').textContent = '12.1';
                    document.getElementById('maxDepth').textContent = '1,987';
                    document.getElementById('platformCount').textContent = data.data_summary?.unique_platforms || '11';
                    document.getElementById('activePlatforms').textContent = data.data_summary?.unique_platforms || '11';
                } else {
                    throw new Error('Backend not available');
                }
            } catch (error) {
                console.warn('Using fallback data:', error);
                // Fallback to real database stats
                document.getElementById('totalMeasurements').textContent = '7,762';
                document.getElementById('avgTemperature').textContent = '12.1';
                document.getElementById('maxDepth').textContent = '1,987';
                document.getElementById('platformCount').textContent = '11';
                document.getElementById('activePlatforms').textContent = '11';
            }
            
            document.getElementById('dataCompleteness').textContent = '100%';
            document.getElementById('lastQualityCheck').textContent = 'Today';
            document.getElementById('latestUpdate').textContent = new Date().toLocaleDateString();
        }
        
        // Load static ARGO platform markers
        async function loadStaticMarkers() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/map_data`);
                const data = await response.json();
                
                if (data.success && data.static_platforms) {
                    data.static_platforms.forEach(platform => {
                        const marker = L.marker([platform.latitude, platform.longitude])
                            .bindPopup(`
                                <strong>Platform ${platform.platform_number}</strong><br>
                                Measurements: ${platform.measurement_count}<br>
                                Location: ${platform.latitude.toFixed(2)}°, ${platform.longitude.toFixed(2)}°
                            `);
                        marker.addTo(currentMap);
                        staticMarkers.push(marker);
                    });
                    
                    // Update platform count
                    document.getElementById('activePlatforms').textContent = data.static_platforms.length;
                    document.getElementById('platformCount').textContent = data.static_platforms.length;
                }
            } catch (error) {
                console.error('Error loading static markers:', error);
                // Set default values if API fails
                document.getElementById('activePlatforms').textContent = '127';
                document.getElementById('platformCount').textContent = '127';
            }
        }
        
        // Setup event listeners
        function setupEventListeners() {
            sendButton.addEventListener('click', sendMessage);
            
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Query type selection
            document.querySelectorAll('.query-type-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.query-type-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentQueryType = this.dataset.type;
                    updatePlaceholder();
                });
            });
        }
        
        // Update input placeholder based on query type
        function updatePlaceholder() {
            const placeholders = {
                sql: 'Ask about ARGO data, ocean temperatures, platform locations...',
                semantic: 'Describe what you want to explore in natural language...',
                mcp: 'Request advanced analytics and computations...',
                viz: 'Ask for charts, graphs, or visual analysis...'
            };
            chatInput.placeholder = placeholders[currentQueryType] || placeholders.sql;
        }
        
        // Update query type display
        function updateQueryType() {
            document.querySelectorAll('.query-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === currentQueryType);
            });
            updatePlaceholder();
        }
        
        // Switch between chat and dashboard views
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // You can implement different layouts here
            // For now, both views show the same interface
        }
        
        // Switch visualization tabs
        function switchTab(tabName) {
            document.querySelectorAll('.viz-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.viz-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Resize map if switching to map tab
            if (tabName === 'map' && currentMap) {
                setTimeout(() => currentMap.invalidateSize(), 100);
            }
        }
        
        // Set query from sample questions
        function setQuery(query) {
            chatInput.value = query;
            chatInput.focus();
            
            // Auto-select appropriate query type based on question
            if (query.includes('chart') || query.includes('plot') || query.includes('visualiz') || query.includes('graph')) {
                currentQueryType = 'viz';
                updateQueryType();
            } else if (query.includes('trend') || query.includes('pattern') || query.includes('analyz')) {
                currentQueryType = 'mcp';
                updateQueryType();
            }
        }
        
        // Send message
        async function sendMessage() {
            const query = chatInput.value.trim();
            if (!query) return;
            
            // Add user message
            addMessage(query, 'user');
            chatInput.value = '';
            
            // Show loading
            loadingIndicator.style.display = 'block';
            
            try {
                let response;
                let endpoint;
                let requestBody;
                
                if (currentQueryType === 'sql') {
                    endpoint = '/api/sql_query';
                    requestBody = { question: query };
                } else if (currentQueryType === 'semantic') {
                    endpoint = '/api/semantic_query';
                    requestBody = { question: query };
                } else if (currentQueryType === 'viz') {
                    // Handle visualization requests
                    await handleVisualizationRequest(query);
                    return;
                } else {
                    endpoint = '/api/mcp_request';
                    requestBody = {
                        method: "tools/call",
                        params: {
                            name: "query_argo_data",
                            arguments: {
                                query: query,
                                limit: 100
                            }
                        }
                    };
                }
                
                response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody),
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                console.log('API Response:', data);
                
                // Handle response
                let message = '';
                if (typeof data === 'string') {
                    message = data;
                } else if (data.response) {
                    message = data.response;
                } else if (data.result) {
                    message = data.result;
                } else if (data.answer) {
                    message = data.answer;
                } else {
                    const keys = Object.keys(data);
                    const textKey = keys.find(key => 
                        typeof data[key] === 'string' && 
                        data[key].length > 10 && 
                        key !== 'query_type' && 
                        key !== 'cached'
                    );
                    if (textKey) {
                        message = data[textKey];
                    } else {
                        message = JSON.stringify(data, null, 2);
                    }
                }
                
                addMessage(message, 'bot');
                
                // Update map if platform data is available
                if (data.map_data && Array.isArray(data.map_data)) {
                    updateMapWithQuery(data.map_data);
                }
                
                // Create visualizations if data contains numerical data
                if (data.numerical_data || data.chart_data) {
                    createDataVisualization(data);
                }
                
            } catch (error) {
                console.error('Fetch Error:', error);
                addMessage(`Connection Error: ${error.message}. Please check if the backend is running on ${API_BASE_URL}`, 'bot');
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }
        
        // Handle visualization requests with real data
        async function handleVisualizationRequest(query) {
            try {
                if (query.toLowerCase().includes('temperature')) {
                    await createTemperatureVisualization();
                } else if (query.toLowerCase().includes('depth') && query.toLowerCase().includes('distribution')) {
                    await createDepthDistributionVisualization();
                } else if (query.toLowerCase().includes('monthly') || query.toLowerCase().includes('trend')) {
                    await createMonthlyTrendsVisualization();
                } else if (query.toLowerCase().includes('scatter')) {
                    await createScatterPlot();
                } else if (query.toLowerCase().includes('heatmap')) {
                    await createHeatmap();
                } else {
                    // Default visualization - show depth distribution
                    await createDepthDistributionVisualization();
                }
            } catch (error) {
                console.error('Visualization error:', error);
                addMessage('Error creating visualization. Please try again.', 'bot');
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }
        
        // Create real temperature visualization with API data
        async function createTemperatureVisualization() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/temperature_patterns`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error('Failed to load temperature data');
                }
                
                const chartContainer = document.createElement('div');
                chartContainer.className = 'chart-container';
                chartContainer.innerHTML = `
                    <div class="chart-title">
                        <i class="fas fa-thermometer-half"></i>
                        Temperature Distribution Analysis
                    </div>
                    <div class="chart-wrapper" id="tempViz"></div>
                    <div class="chart-description">
                        Generated temperature distribution showing the relationship between depth and temperature measurements from ${data.count} ARGO measurements.
                    </div>
                `;
                chatMessages.appendChild(chartContainer);
                
                // Create Plotly scatter plot with real data
                const trace = {
                    x: data.pressures.slice(0, 200), // Limit for performance
                    y: data.temperatures.slice(0, 200),
                    mode: 'markers',
                    type: 'scatter',
                    name: 'Temperature vs Depth',
                    marker: {
                        color: data.temperatures.slice(0, 200),
                        colorscale: 'Viridis',
                        size: 6,
                        colorbar: {
                            title: 'Temperature (°C)'
                        }
                    }
                };
                
                const layout = {
                    title: 'ARGO Temperature vs Depth Profile',
                    xaxis: { title: 'Depth (dbar)' },
                    yaxis: { title: 'Temperature (°C)' },
                    height: 400,
                    margin: { t: 50, r: 50, b: 50, l: 50 }
                };
                
                Plotly.newPlot('tempViz', [trace], layout);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
            } catch (error) {
                console.error('Temperature visualization error:', error);
                addMessage('Error creating temperature visualization. Using sample data instead.', 'bot');
                createSampleTemperatureVisualization();
            }
        }
        
        // Create real depth distribution visualization
        async function createDepthDistributionVisualization() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/depth_distribution`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error('Failed to load depth data');
                }
                
                const chartContainer = document.createElement('div');
                chartContainer.className = 'chart-container';
                chartContainer.innerHTML = `
                    <div class="chart-title">
                        <i class="fas fa-chart-bar"></i>
                        Depth Distribution Histogram
                    </div>
                    <div class="chart-wrapper" id="depthViz"></div>
                    <div class="chart-description">
                        Generated depth distribution histogram showing the frequency of measurements at different depth levels. Total: ${data.total_measurements} measurements.
                    </div>
                `;
                chatMessages.appendChild(chartContainer);
                
                // Create Plotly bar chart with real data
                const trace = {
                    x: data.categories,
                    y: data.counts,
                    type: 'bar',
                    name: 'Measurement Count',
                    marker: {
                        color: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe'],
                        opacity: 0.8
                    }
                };
                
                const layout = {
                    title: `ARGO Depth Distribution (${data.total_measurements} total measurements)`,
                    xaxis: { title: 'Depth Categories' },
                    yaxis: { title: 'Number of Measurements' },
                    height: 400,
                    margin: { t: 50, r: 50, b: 50, l: 50 }
                };
                
                Plotly.newPlot('depthViz', [trace], layout);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
            } catch (error) {
                console.error('Depth visualization error:', error);
                addMessage('Error creating depth visualization. Using sample data instead.', 'bot');
                createSampleDepthVisualization();
            }
        }
        
        // Create monthly trends visualization
        async function createMonthlyTrendsVisualization() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/monthly_trends`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error('Failed to load monthly trend data');
                }
                
                const chartContainer = document.createElement('div');
                chartContainer.className = 'chart-container';
                chartContainer.innerHTML = `
                    <div class="chart-title">
                        <i class="fas fa-chart-line"></i>
                        Platform Measurement Analysis
                    </div>
                    <div class="chart-wrapper" id="trendsViz"></div>
                    <div class="chart-description">
                        Generated visualization showing measurement counts and average temperatures by ARGO platform.
                    </div>
                `;
                chatMessages.appendChild(chartContainer);
                
                // Create dual axis chart
                const trace1 = {
                    x: data.platforms,
                    y: data.measurements,
                    type: 'bar',
                    name: 'Measurements',
                    marker: { color: '#667eea' },
                    yaxis: 'y'
                };
                
                const trace2 = {
                    x: data.platforms,
                    y: data.avg_temperatures,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Avg Temperature (°C)',
                    marker: { color: '#f5576c' },
                    yaxis: 'y2'
                };
                
                const layout = {
                    title: 'ARGO Platform Analysis',
                    xaxis: { title: 'Platform Number' },
                    yaxis: { title: 'Number of Measurements', side: 'left' },
                    yaxis2: {
                        title: 'Average Temperature (°C)',
                        side: 'right',
                        overlaying: 'y'
                    },
                    height: 400,
                    margin: { t: 50, r: 50, b: 50, l: 50 }
                };
                
                Plotly.newPlot('trendsViz', [trace1, trace2], layout);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
            } catch (error) {
                console.error('Trends visualization error:', error);
                addMessage('Error creating trends visualization. Using sample data instead.', 'bot');
                createSampleTrendsVisualization();
            }
        }
        
        // Fallback sample visualizations
        function createSampleTemperatureVisualization() {
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.innerHTML = `
                <div class="chart-title">
                    <i class="fas fa-thermometer-half"></i>
                    Temperature Distribution Analysis (Sample)
                </div>
                <div class="chart-wrapper" id="tempVizSample"></div>
            `;
            chatMessages.appendChild(chartContainer);
            
            const trace = {
                x: Array.from({length: 50}, (_, i) => i * 40),
                y: Array.from({length: 50}, (_, i) => 25 - (i * 0.4) + Math.random() * 3),
                type: 'scatter',
                mode: 'markers',
                marker: {
                    size: 8,
                    color: Array.from({length: 100}, () => 20 + Math.random() * 15),
                    colorscale: 'Viridis',
                    showscale: true,
                    colorbar: {
                        title: 'Temperature (°C)'
                    }
                },
                name: 'Temperature by Depth'
            };
            
            const layout = {
                title: '',
                xaxis: { title: 'Depth (m)' },
                yaxis: { title: 'Temperature (°C)' },
                height: 280,
                margin: { l: 50, r: 50, t: 20, b: 50 }
            };
            
            Plotly.newPlot('tempViz', [trace], layout, {responsive: true});
            
            addMessage('Generated temperature distribution visualization showing the relationship between depth and temperature measurements.', 'bot');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Create depth visualization
        function createDepthVisualization() {
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.innerHTML = `
                <div class="chart-title">
                    <i class="fas fa-chart-bar"></i>
                    Depth Distribution Histogram
                </div>
                <div class="chart-wrapper" id="depthViz"></div>
            `;
            chatMessages.appendChild(chartContainer);
            
            const depths = Array.from({length: 500}, () => Math.random() * 2000);
            
            const trace = {
                x: depths,
                type: 'histogram',
                nbinsx: 20,
                marker: {
                    color: '#667eea',
                    opacity: 0.7,
                    line: {
                        color: '#5a67d8',
                        width: 1
                    }
                },
                name: 'Depth Measurements'
            };
            
            const layout = {
                title: '',
                xaxis: { title: 'Depth (m)' },
                yaxis: { title: 'Frequency' },
                height: 280,
                margin: { l: 50, r: 50, t: 20, b: 50 }
            };
            
            Plotly.newPlot('depthViz', [trace], layout, {responsive: true});
            
            addMessage('Generated depth distribution histogram showing the frequency of measurements at different depth levels.', 'bot');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Create scatter plot
        function createScatterPlot() {
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.innerHTML = `
                <div class="chart-title">
                    <i class="fas fa-chart-scatter"></i>
                    Salinity vs Temperature Scatter Plot
                </div>
                <div class="chart-wrapper" id="scatterViz"></div>
            `;
            chatMessages.appendChild(chartContainer);
            
            const n = 200;
            const trace = {
                x: Array.from({length: n}, () => 34 + Math.random() * 2),
                y: Array.from({length: n}, () => 20 + Math.random() * 15),
                mode: 'markers',
                type: 'scatter',
                marker: {
                    size: 8,
                    color: Array.from({length: n}, () => Math.random() * 2000),
                    colorscale: 'Ocean',
                    showscale: true,
                    colorbar: {
                        title: 'Depth (m)'
                    },
                    opacity: 0.7
                },
                name: 'T-S Relationship'
            };
            
            const layout = {
                title: '',
                xaxis: { title: 'Salinity (PSU)' },
                yaxis: { title: 'Temperature (°C)' },
                height: 280,
                margin: { l: 50, r: 50, t: 20, b: 50 }
            };
            
            Plotly.newPlot('scatterViz', [trace], layout, {responsive: true});
            
            addMessage('Generated temperature-salinity scatter plot colored by depth, showing oceanographic water mass characteristics.', 'bot');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Create heatmap
        function createHeatmap() {
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.innerHTML = `
                <div class="chart-title">
                    <i class="fas fa-map"></i>
                    Geographic Temperature Heatmap
                </div>
                <div class="chart-wrapper" id="heatmapViz"></div>
            `;
            chatMessages.appendChild(chartContainer);
            
            const z = [];
            for (let i = 0; i < 20; i++) {
                const row = [];
                for (let j = 0; j < 20; j++) {
                    row.push(20 + Math.random() * 15);
                }
                z.push(row);
            }
            
            const trace = {
                z: z,
                type: 'heatmap',
                colorscale: 'RdYlBu',
                colorbar: {
                    title: 'Temperature (°C)'
                }
            };
            
            const layout = {
                title: '',
                xaxis: { title: 'Longitude Grid' },
                yaxis: { title: 'Latitude Grid' },
                height: 280,
                margin: { l: 50, r: 50, t: 20, b: 50 }
            };
            
            Plotly.newPlot('heatmapViz', [trace], layout, {responsive: true});
            
            addMessage('Generated geographic temperature heatmap showing spatial distribution of water temperatures.', 'bot');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Create general visualization
        function createGeneralVisualization(query) {
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.innerHTML = `
                <div class="chart-title">
                    <i class="fas fa-chart-line"></i>
                    Data Analysis Visualization
                </div>
                <div class="chart-wrapper" id="generalViz"></div>
            `;
            chatMessages.appendChild(chartContainer);
            
            const trace1 = {
                x: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                y: [1200, 1100, 1300, 1250, 1400, 1350, 1300, 1200, 1150, 1250, 1300, 1200],
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Measurements',
                line: { color: '#667eea' }
            };
            
            const layout = {
                title: '',
                xaxis: { title: 'Month' },
                yaxis: { title: 'Count' },
                height: 280,
                margin: { l: 50, r: 50, t: 20, b: 50 }
            };
            
            Plotly.newPlot('generalViz', [trace1], layout, {responsive: true});
            
            addMessage(`Generated visualization based on your query: "${query}". This shows sample data trends over time.`, 'bot');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Add message to chat
        function addMessage(message, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add(`${sender}-message`);
            messageDiv.innerHTML = message.replace(/\n/g, '<br>');
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Update map with query results
        function updateMapWithQuery(platforms) {
            // Clear previous query markers
            queryMarkers.forEach(marker => currentMap.removeLayer(marker));
            queryMarkers = [];
            
            // Add new query markers in red
            platforms.forEach(platform => {
                const marker = L.marker([platform.latitude, platform.longitude], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).bindPopup(`
                    <strong>Query Result - Platform ${platform.platform_number}</strong><br>
                    Measurements: ${platform.measurement_count}<br>
                    Location: ${platform.latitude.toFixed(2)}°, ${platform.longitude.toFixed(2)}°
                `);
                
                marker.addTo(currentMap);
                queryMarkers.push(marker);
            });
            
            // Fit map to show all query markers
            if (queryMarkers.length > 0) {
                const group = new L.featureGroup(queryMarkers);
                currentMap.fitBounds(group.getBounds().pad(0.1));
            }
        }
        
        // Create data visualization from API response
        function createDataVisualization(data) {
            // This would create charts based on actual API data
            // Implementation depends on your backend data structure
            console.log('Creating visualization for data:', data);
        }
        
        // Visualization panel controls
        function exportChart() {
            alert('Export functionality would download the current chart as PNG/PDF');
        }
        
        function refreshViz() {
            // Refresh current visualizations
            if (currentMap) {
                currentMap.invalidateSize();
            }
            Object.values(chartInstances).forEach(chart => {
                if (chart.update) chart.update();
            });
        }
        
        function toggleFullscreen() {
            const vizPanel = document.querySelector('.viz-panel');
            if (vizPanel.style.width === '100%') {
                vizPanel.style.width = '400px';
            } else {
                vizPanel.style.width = '100%';
            }
            setTimeout(() => {
                if (currentMap) currentMap.invalidateSize();
                Object.values(chartInstances).forEach(chart => {
                    if (chart.resize) chart.resize();
                });
            }, 300);
        }
    </script>
</body>
</html>